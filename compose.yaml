networks:
    web_to_db:
    web_to_ad:
    ad_to_provider:
    ad_to_db:


# One or more services can be defined under the top-level key: services.
services:
    # The name postgres is the name of the database service.
    # This arbitrary name becomes the hostname of the container.
    postgres:
        # The image to use to create the container.
        image: postgres:15-alpine
        # The command is passed as arguments to the ENTRYPOINT script. 
        command: "-c shared_buffers=256MB -c max_connections=200"
        # Instructs compose to restart the container if it shuts 
        # down unless the container is intentionally stopped.
        restart: unless-stopped
        healthcheck:
            test: pg_isready -U "$$POSTGRES_USER" -d "$$POSTGRES_PASSWORD" -h postgres
            interval: 3s
            retries: 5
        # The networks attached to the container.
        networks:
            - web_to_db
            - ad_to_db
        # Environment variables used to configure the database. 
        environment:
            - POSTGRES_USER=web_app
            - POSTGRES_PASSWORD=74jrjdSj
            - POSTGRES_DB=postgres

    db_init:
        build:
            context: src/webapp
            dockerfile: ../Dockerfile
            args:
                application_dir: webapp
        command: /bin/sh -c "python3 -m webapp.app"
        networks:
            - web_to_db
        environment:
            - DATABASE_HOST=postgres
            - DATABASE_USER=web_app
            - DATABASE_PASS=74jrjdSj
            - DATABASE_NAME=postgres
            - SERVICE_NAME=overshare
        depends_on: 
            postgres:
                condition: service_healthy
        restart: "no"

    web_app:
        build:
            context: src/webapp
            dockerfile: ../Dockerfile
            args:
                application_dir: webapp
        networks:
            - web_to_db
            - web_to_ad
        ports:
            - "5000:9000"
        environment:
            - DATABASE_HOST=postgres
            - DATABASE_USER=web_app
            - DATABASE_PASS=74jrjdSj
            - DATABASE_NAME=postgres
            - ADSERVE_HOST=adserve
            - ADSERVE_PORT=9000
            - ADSERVE_PATH=/serve
            - SIGNOZ_HOST
            - SERVICE_NAME=overshare
        depends_on: 
            postgres:
                condition: service_healthy
    
    adprovider:
        build:
            context: src/adprovider
            dockerfile: ../Dockerfile
            args:
                application_dir: adprovider
        networks:
            - ad_to_provider
            - ad_to_db
        environment:
            - DATABASE_HOST=postgres
            - DATABASE_USER=web_app
            - DATABASE_PASS=74jrjdSj
            - DATABASE_NAME=postgres
            - SIGNOZ_HOST
            - SERVICE_NAME=adprovider
        depends_on: 
            postgres:
                condition: service_healthy

    adserve:
        build:
            context: src/adserve
            dockerfile: ../Dockerfile
            args:
                application_dir: adserve
        networks:
            - web_to_ad
            - ad_to_provider
        environment:
            - SERVICE_NAME=adserve
            - SIGNOZ_HOST
            - PROVIDER_HOST=adprovider
            - PROVIDER_PORT=9000
            - PROVIDER_PATH=/inform

    # Simulate traffic to the web app.
    simulate:
        build: ./src/simulate
        networks:
            - web_to_ad
        depends_on: 
            - web_app